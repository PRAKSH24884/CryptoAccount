<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Data Processor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary, .btn-success, .btn-warning {
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        .btn-success {
            background: linear-gradient(45deg, #11998e, #38ef7d);
        }
        .btn-warning {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        .table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
        }
        .loading {
            display: none;
        }
        .result-section {
            display: none;
        }
        .output-selection {
            display: none;
        }
        .error-row {
            background-color: #ffe6e6;
        }
        .done-row {
            background-color: #e6ffe6;
        }
        .summary-row {
            background-color: #f8f9fa !important;
            font-weight: bold;
            border-top: 2px solid #dee2e6;
        }
        .summary-row td {
            border-top: 2px solid #dee2e6;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .alert-warning ul {
            margin-bottom: 0;
        }
        
        .alert-warning li {
            margin-bottom: 0.25rem;
        }
        
        /* Fullscreen improvements */
        .container-fluid {
            max-width: 100%;
        }
        
        .table-responsive {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Filter section styling */
        .bg-light {
            background-color: #f8f9fa !important;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem !important;
            }
            
            .display-4 {
                font-size: 2rem;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid p-3">
        <div class="row">
            <div class="col-12">
                <div class="main-container p-4">
                    <div class="text-center mb-5">
                        <h1 class="display-4 fw-bold text-primary mb-3">
                            <i class="fas fa-chart-line me-3"></i>
                            Crypto Trading Data Processor
                        </h1>
                        <p class="lead text-muted">Upload your Excel/CSV file, process your cryptocurrency trading data, and generate detailed reports</p>
                    </div>

                    <!-- File Upload Form -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-upload me-2"></i>
                                Upload Your File
                            </h5>
                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="row g-3 align-items-center">
                                    <div class="col-md-6">
                                        <input class="form-control" type="file" id="fileInput" name="file" accept=".xlsx,.xls,.csv" required>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control" id="daysLimit" name="days_limit" placeholder="Days Limit (default 10)" min="1" max="365" value="10">
                                    </div>
                                    <div class="col-md-3">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-upload me-2"></i>Upload & Process
                                        </button>
                                    </div>
                                </div>
                            </form>
                            <div id="uploadStatus" class="mt-3"></div>
                        </div>
                    </div>



                    <!-- Output Selection -->
                    <div class="output-selection card mb-4" id="outputSelection">
                        <div class="card-body text-center">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-list me-2"></i>
                                Select Output Type
                            </h5>
                            <div class="row justify-content-center">
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="showOutput('nolimit')">
                                        <i class="fas fa-infinity me-2"></i>
                                        No Limit Output
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-success w-100 mb-2" onclick="showOutput('dayslimit')">
                                        <i class="fas fa-clock me-2"></i>
                                        Days Limit Output
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Section -->
                    <div class="loading text-center py-5" id="loadingSection">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                        <p class="mt-3">Processing your data...</p>
                    </div>

                    <!-- Results Section -->
                    <div class="result-section" id="resultSection">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0" id="outputTitle">
                                        <i class="fas fa-table me-2"></i>
                                        Output Results
                                    </h5>
                                    <div>
                                        <button class="btn btn-warning me-2" onclick="showOutputSelection()">
                                            <i class="fas fa-arrow-left me-2"></i>Change Output
                                        </button>
                                        <a id="downloadBtn" class="btn btn-success" href="#" target="_blank" download>
                                            <i class="fas fa-download me-2"></i>Download CSV
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Filter Section -->
                                <div class="row mb-3" id="filterSection" style="display: none;">
                                    <div class="col-md-12">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-filter me-2"></i>Filter Options
                                                </h6>
                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Asset</label>
                                                        <select class="form-select" id="assetFilter">
                                                            <option value="">All Assets</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Status</label>
                                                        <select class="form-select" id="statusFilter">
                                                            <option value="">All Status</option>
                                                            <option value="DONE">DONE</option>
                                                            <option value="ERROR">ERROR</option>
                                                            <option value="BALANCE CARRIED FORWARD">BALANCE</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Min P/L</label>
                                                        <input type="number" class="form-control" id="minPLFilter" placeholder="Min P/L">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Max P/L</label>
                                                        <input type="number" class="form-control" id="maxPLFilter" placeholder="Max P/L">
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-12">
                                                        <button class="btn btn-primary btn-sm" onclick="applyFilters()">
                                                            <i class="fas fa-search me-1"></i>Apply Filters
                                                        </button>
                                                        <button class="btn btn-secondary btn-sm ms-2" onclick="clearFilters()">
                                                            <i class="fas fa-times me-1"></i>Clear Filters
                                                        </button>
                                                        <span class="ms-3 text-muted" id="filterInfo"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped" id="dataTable">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>ASSET</th>
                                                <th>Sell Date</th>
                                                <th>Sell Amount</th>
                                                <th>Buy Date</th>
                                                <th>Buy Amount</th>
                                                <th>Buy Price</th>
                                                <th>Sell Price</th>
                                                <th>Cost Basis</th>
                                                <th>Proceeds USDT</th>
                                                <th>Proceeds</th>
                                                <th>P/L</th>
                                                <th>TDS</th>
                                                <th>REMARK</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let processedData = null;
        let currentData = null; // Store current displayed data for filtering
        const uploadForm = document.getElementById('uploadForm');
        const loadingSection = document.getElementById('loadingSection');
        const resultSection = document.getElementById('resultSection');
        const outputSelection = document.getElementById('outputSelection');
        const uploadStatus = document.getElementById('uploadStatus');
        const dataTableBody = document.getElementById('dataTableBody');
        const downloadBtn = document.getElementById('downloadBtn');
        const outputTitle = document.getElementById('outputTitle');
        const filterSection = document.getElementById('filterSection');


        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadStatus.innerHTML = '';
            resultSection.style.display = 'none';
            outputSelection.style.display = 'none';
            loadingSection.style.display = 'block';

            const formData = new FormData(uploadForm);
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loadingSection.style.display = 'none';
                if (data.success) {
                    processedData = data;
                    outputSelection.style.display = 'block';
                    
                    // Show success message
                    let statusHtml = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            File processed successfully! Please select output type.
                        </div>
                    `;
                    
                    // Show error messages if any
                    if (data.has_errors && data.errors && data.errors.length > 0) {
                        statusHtml += `
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Processing Warnings:</strong>
                                <ul class="mb-0 mt-2">
                        `;
                        data.errors.forEach(error => {
                            statusHtml += `<li>${error}</li>`;
                        });
                        statusHtml += `
                                </ul>
                            </div>
                        `;
                    }
                    
                    uploadStatus.innerHTML = statusHtml;
                } else {
                    uploadStatus.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>${data.error}</div>`;
                }
            })
            .catch(error => {
                loadingSection.style.display = 'none';
                uploadStatus.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Network error occurred</div>`;
            });
        });

        function showOutput(type) {
            if (!processedData) return;
            
            outputSelection.style.display = 'none';
            resultSection.style.display = 'block';
            
            let data, filename, title;
            
            if (type === 'nolimit') {
                data = processedData.nolimit_preview;
                filename = processedData.nolimit_file;
                title = 'No Limit Output';
            } else {
                data = processedData.dayslimit_preview;
                filename = processedData.dayslimit_file;
                title = `${processedData.days_limit} Days Limit Output`;
            }
            
            outputTitle.innerHTML = `<i class="fas fa-table me-2"></i>${title}`;
            downloadBtn.href = '/download/' + filename;
            downloadBtn.download = filename;
            
            currentData = data; // Store current data for filtering
            fillTable(dataTableBody, data);
            setupFilters(data);
        }

        function showOutputSelection() {
            resultSection.style.display = 'none';
            outputSelection.style.display = 'block';
        }

        function setupFilters(data) {
            // Show filter section
            filterSection.style.display = 'block';
            
            // Populate asset filter
            const assetFilter = document.getElementById('assetFilter');
            const assets = [...new Set(data.map(row => row.ASSET))];
            assetFilter.innerHTML = '<option value="">All Assets</option>';
            assets.forEach(asset => {
                assetFilter.innerHTML += `<option value="${asset}">${asset}</option>`;
            });
            
            // Clear other filters
            document.getElementById('statusFilter').value = '';
            document.getElementById('minPLFilter').value = '';
            document.getElementById('maxPLFilter').value = '';
            document.getElementById('filterInfo').textContent = '';
        }

        function applyFilters() {
            if (!currentData) return;
            
            const assetFilter = document.getElementById('assetFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const minPL = document.getElementById('minPLFilter').value;
            const maxPL = document.getElementById('maxPLFilter').value;
            
            let filteredData = currentData.filter(row => {
                // Asset filter
                if (assetFilter && row.ASSET !== assetFilter) return false;
                
                // Status filter
                if (statusFilter && row.REMARK !== statusFilter) return false;
                
                // P/L range filter
                if (minPL && (row['P/L'] === 'NIL' || parseFloat(row['P/L']) < parseFloat(minPL))) return false;
                if (maxPL && (row['P/L'] === 'NIL' || parseFloat(row['P/L']) > parseFloat(maxPL))) return false;
                
                return true;
            });
            
            fillTable(dataTableBody, filteredData);
            
            // Update filter info
            const filterInfo = document.getElementById('filterInfo');
            filterInfo.textContent = `Showing ${filteredData.length} of ${currentData.length} rows`;
        }

        function clearFilters() {
            document.getElementById('assetFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('minPLFilter').value = '';
            document.getElementById('maxPLFilter').value = '';
            document.getElementById('filterInfo').textContent = '';
            
            if (currentData) {
                fillTable(dataTableBody, currentData);
            }
        }

        function fillTable(tbody, rows) {
            tbody.innerHTML = '';
            
            // Calculate totals
            let totalSellAmount = 0;
            let totalBuyAmount = 0;
            let totalCostBasis = 0;
            let totalProceeds = 0;
            let totalPL = 0;
            let totalTDS = 0;
            let doneCount = 0;
            let errorCount = 0;
            
            rows.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = row.REMARK === 'ERROR' ? 'error-row' : 'done-row';
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${row.ASSET}</td>
                    <td>${row['Sell Date']}</td>
                    <td>${row['Sell Amount']}</td>
                    <td>${row['Buy Date']}</td>
                    <td>${row['Buy Amount Used']}</td>
                    <td>${row['Buy Price']}</td>
                    <td>${row['Sell Price']}</td>
                    <td>${row['Cost Basis']}</td>
                    <td>${row['Proceds USDT']}</td>
                    <td>${row['Proceeds']}</td>
                    <td>${row['P/L']}</td>
                    <td>${row['TDS']}</td>
                    <td><span class="badge ${row.REMARK === 'ERROR' ? 'bg-danger' : 'bg-success'}">${row.REMARK}</span></td>
                `;
                tbody.appendChild(tr);
                
                // Calculate totals (only for numeric values)
                if (row['Sell Amount'] !== 'NIL' && !isNaN(row['Sell Amount'])) {
                    totalSellAmount += parseFloat(row['Sell Amount']);
                }
                if (row['Buy Amount Used'] !== 'NIL' && !isNaN(row['Buy Amount Used'])) {
                    totalBuyAmount += parseFloat(row['Buy Amount Used']);
                }
                if (row['Cost Basis'] !== 'NIL' && !isNaN(row['Cost Basis'])) {
                    totalCostBasis += parseFloat(row['Cost Basis']);
                }
                if (row['Proceeds'] !== 'NIL' && !isNaN(row['Proceeds'])) {
                    totalProceeds += parseFloat(row['Proceeds']);
                }
                if (row['P/L'] !== 'NIL' && !isNaN(row['P/L'])) {
                    totalPL += parseFloat(row['P/L']);
                }
                if (row['TDS'] !== 'NIL' && !isNaN(row['TDS'])) {
                    totalTDS += parseFloat(row['TDS']);
                }
                
                // Count status
                if (row.REMARK === 'DONE') {
                    doneCount++;
                } else if (row.REMARK === 'ERROR') {
                    errorCount++;
                }
            });
            
            // Add summary row
            const summaryRow = document.createElement('tr');
            summaryRow.className = 'summary-row';
            summaryRow.style.backgroundColor = '#f8f9fa';
            summaryRow.style.fontWeight = 'bold';
            summaryRow.innerHTML = `
                <td colspan="2"><strong>TOTAL (${rows.length} rows)</strong></td>
                <td>-</td>
                <td>${totalSellAmount.toFixed(2)}</td>
                <td>-</td>
                <td>${totalBuyAmount.toFixed(2)}</td>
                <td>-</td>
                <td>-</td>
                <td>${totalCostBasis.toFixed(2)}</td>
                <td>-</td>
                <td>${totalProceeds.toFixed(2)}</td>
                <td>${totalPL.toFixed(2)}</td>
                <td>${totalTDS.toFixed(2)}</td>
                <td><span class="badge bg-info">DONE: ${doneCount} | ERROR: ${errorCount}</span></td>
            `;
            tbody.appendChild(summaryRow);
        }
    </script>
</body>
</html> 